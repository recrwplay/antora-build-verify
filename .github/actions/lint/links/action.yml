name: 'Check new links'
description: 'Check new links in the deployed docs'

inputs:
  git-token:
    description: 'a token for git commands'
    required: true
  base:
    description: 'base branch'
    type: string
    required: true
  head:
    description: 'head branch'
    type: string
    required: true

runs:
  using: "composite"
  steps: 
    
    # turn this into a matrix to get all **/antora.yml files for eg drivers or docs in subdirs
    - name: Read antora component name
      id: antora-component-name
      uses: jbutcher5/read-yaml@main
      with:
        file: './antora.yml'
        key-path: '["name"]'

    - name: Read antora component version
      id: antora-component-version
      uses: jbutcher5/read-yaml@main
      with:
        file: './antora.yml'
        key-path: '["version"]'

    - run: git fetch origin ${{ inputs.base }}
      shell: bash

    - run: 'git diff origin/${{ inputs.base }}..HEAD -Glink: --name-only | npx pino-pretty | perl -ne "if (/^modules\/ROOT\/pages\/(.*)\.adoc/) { print \"\$1\n\" }" > linklog'
      shell: bash

    # for each file in linklog, run check-links



    # - name: Find links to test
    #     run: |
    #       git diff ${{ inputs.base }}..${{ inputs.head }} -Glink\: --name-only | npx pino-pretty > linklog
    #     env:
    #       GITHUB_TOKEN: ${{ inputs.git-token }}

    - name: Upload linklog
      uses: actions/upload-artifact@v3
      with:
        name: docs
        path: linklog

    # - run: npm run check-links